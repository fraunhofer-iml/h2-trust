// Copyright Fraunhofer Institute for Material Flow and Logistics
//
// Licensed under the Apache License, Version 2.0 (the "License").
// For details on the licensing terms, see the LICENSE file.
// SPDX-License-Identifier: Apache-2.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CompanyType {
  HYDROGEN_PRODUCER
  POWER_PRODUCER
  HYDROGEN_RECIPIENT
}

enum HydrogenColor {
  GREEN
  ORANGE
  PINK
  YELLOW
  MIX
}

enum BatchType {
  HYDROGEN
  POWER
}

enum PowerAccessApprovalStatus {
  APPROVED
  PENDING
  REJECTED
}

model Address {
  id         String   @id @default(cuid(2))
  street     String
  postalCode String
  city       String
  state      String
  country    String
  latitude   Decimal? @db.Decimal(8, 6)
  longitude  Decimal? @db.Decimal(9, 6)

  companies Company[]
  units     Unit[]

  @@unique([street, postalCode, city, state, country])
}

model Document {
  id          String @id @default(cuid(2))
  description String
  location    String

  unit   Unit?   @relation(fields: [unitId], references: [id])
  unitId String?

  processStep   ProcessStep? @relation(fields: [processStepId], references: [id])
  processStepId String?

  powerAccessApprovals PowerAccessApproval[]
}

model Company {
  id          String @id @default(cuid(2))
  name        String
  mastrNumber String @unique

  companyType CompanyType

  address   Address @relation(fields: [addressId], references: [id])
  addressId String

  hydrogenApprovals PowerAccessApproval[] @relation(name: "HydrogenProducer")
  powerApprovals    PowerAccessApproval[] @relation(name: "PowerProducer")
  unitOwners        Unit[]                @relation(name: "UnitOwner")
  unitOperators     Unit[]                @relation(name: "UnitOperator")
  users             User[]
  batches           Batch[]
}

model User {
  id    String @id @default(cuid(2))
  name  String
  email String @unique

  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  processSteps ProcessStep[]
}

model Unit {
  id             String   @id @default(cuid(2))
  name           String
  mastrNumber    String   @unique
  manufacturer   String
  modelType      String
  modelNumber    String
  serialNumber   String   @unique
  commissionedOn DateTime

  address   Address @relation(fields: [addressId], references: [id])
  addressId String

  owner   Company @relation(name: "UnitOwner", fields: [ownerId], references: [id])
  ownerId String

  operator   Company @relation(name: "UnitOperator", fields: [operatorId], references: [id])
  operatorId String

  powerProductionUnit    PowerProductionUnit?
  hydrogenProductionUnit HydrogenProductionUnit?
  hydrogenStorageUnit    HydrogenStorageUnit?

  documents    Document[]
  processSteps ProcessStep[]
}

model PowerProductionType {
  name          String        @id
  energySource  String
  hydrogenColor HydrogenColor

  powerProductionUnits PowerProductionUnit[]

  @@unique([name, energySource, hydrogenColor])
}

model HydrogenProductionType {
  id         String @id @default(cuid(2))
  method     String
  technology String

  hydrogenProductionUnits HydrogenProductionUnit[]

  @@unique([method, technology])
}

model HydrogenStorageType {
  name String @id

  hydrogenStorageUnits HydrogenStorageUnit[]
}

model GridLevel {
  name String @id

  powerProductionUnits PowerProductionUnit[]
}

model BiddingZone {
  name String @id

  powerProductionUnits    PowerProductionUnit[]
  hydrogenProductionUnits HydrogenProductionUnit[]
}

model PowerProductionUnit {
  id                       String   @id
  decommissioningPlannedOn DateTime
  electricityMeterNumber   String
  ratedPower               Decimal  @db.Decimal(18, 6)
  gridOperator             String
  gridConnectionNumber     String

  generalInfo Unit @relation(fields: [id], references: [id])

  type     PowerProductionType @relation(fields: [typeName], references: [name])
  typeName String

  gridLevel     GridLevel @relation(fields: [gridLevelName], references: [name])
  gridLevelName String

  biddingZone     BiddingZone @relation(fields: [biddingZoneName], references: [name])
  biddingZoneName String

  powerAccessApprovals PowerAccessApproval[]
}

model HydrogenProductionUnit {
  id         String  @id
  ratedPower Decimal @db.Decimal(18, 6)
  pressure   Decimal @db.Decimal(8, 2)

  generalInfo Unit @relation(fields: [id], references: [id])

  type   HydrogenProductionType @relation(fields: [typeId], references: [id])
  typeId String

  biddingZone     BiddingZone @relation(fields: [biddingZoneName], references: [name])
  biddingZoneName String

  hydrogenStorageUnit   HydrogenStorageUnit @relation(fields: [hydrogenStorageUnitId], references: [id])
  hydrogenStorageUnitId String              @unique
}

model HydrogenStorageUnit {
  id       String  @id
  capacity Decimal @db.Decimal(18, 6)
  pressure Decimal @db.Decimal(8, 2)
  filling  Batch[]

  generalInfo Unit @relation(fields: [id], references: [id])

  type     HydrogenStorageType @relation(fields: [typeName], references: [name])
  typeName String

  hydrogenProductionUnits HydrogenProductionUnit[]
}

model Batch {
  id      String    @id @default(cuid(2))
  active  Boolean   @default(true)
  amount  Decimal   @db.Decimal(18, 6)
  quality String
  type    BatchType

  predecessors Batch[] @relation("BatchRelation")
  successors   Batch[] @relation("BatchRelation")

  owner   Company @relation(fields: [ownerId], references: [id])
  ownerId String

  hydrogenStorageUnit   HydrogenStorageUnit? @relation(fields: [hydrogenStorageUnitId], references: [id])
  hydrogenStorageUnitId String?

  processStep ProcessStep?
}

model ProcessType {
  name String @id

  processSteps ProcessStep[]
}

model ProcessStep {
  id        String   @id @default(cuid(2))
  startedAt DateTime
  endedAt   DateTime

  processType     ProcessType @relation(fields: [processTypeName], references: [name])
  processTypeName String

  batch   Batch  @relation(fields: [batchId], references: [id])
  batchId String @unique

  recordedBy User   @relation(fields: [userId], references: [id])
  userId     String

  executedBy Unit   @relation(fields: [unitId], references: [id])
  unitId     String

  documents Document[]
}

model PowerAccessApproval {
  id                        String                    @id @default(cuid(2))
  decidedAt                 DateTime
  powerAccessApprovalStatus PowerAccessApprovalStatus

  powerProducer   Company @relation(fields: [powerProducerId], references: [id], name: "PowerProducer")
  powerProducerId String

  hydrogenProducer   Company @relation(fields: [hydrogenProducerId], references: [id], name: "HydrogenProducer")
  hydrogenProducerId String

  powerProductionUnit   PowerProductionUnit @relation(fields: [powerProductionUnitId], references: [id])
  powerProductionUnitId String

  document   Document @relation(fields: [documentId], references: [id])
  documentId String

  @@unique([powerProducerId, powerProductionUnitId, hydrogenProducerId])
}
