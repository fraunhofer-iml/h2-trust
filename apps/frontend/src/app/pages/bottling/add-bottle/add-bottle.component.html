<div class="flex min-w-min flex-col gap-4 p-6">
  <h3 class="font-semibold text-gray-700">Add bottle</h3>

  <div class="grid grid-cols-2 gap-x-2 gap-y-4" [formGroup]="bottleFormGroup">
    <mat-form-field appearance="outline">
      <mat-label>Date</mat-label>
      <input
        matInput
        [matDatepicker]="picker"
        formControlName="date"
        [max]="dateDelimiter"
        placeholder="Choose a date"
      />
      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Time</mat-label>
      <input
        matInput
        [matTimepicker]="timepicker"
        formControlName="time"
        [max]="dateDelimiter"
        placeholder="Pick a time"
      />
      <mat-timepicker-toggle matIconSuffix [for]="timepicker" />
      <mat-timepicker #timepicker />
    </mat-form-field>

    <mat-button-toggle-group formControlName="amount" required="true" class="col-span-2">
      <mat-button-toggle value="10" class="w-1/2">10 kg</mat-button-toggle>
      <mat-button-toggle value="50" class="w-1/2">50 kg</mat-button-toggle>
    </mat-button-toggle-group>

    <mat-form-field class="custom-input" appearance="outline">
      <mat-label>Recipients</mat-label>
      <mat-select formControlName="recipient" placeholder="Select a Recipient">
        @if (recipientsQuery.isSuccess() && recipientsQuery.data().length) {
          @for (recipient of recipientsQuery.data(); track recipient) {
            <mat-option [value]="recipient">{{ recipient.name }}</mat-option>
          }
        } @else {
          <mat-option [value]="null">No data found.</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Units</mat-label>
      <mat-select formControlName="storageUnit" placeholder="Select a Unit" #storage>
        @for (unit of hydrogenStorageQuery.data(); track unit) {
          <mat-option [value]="unit" [disabled]="(bottleFormGroup.value.amount ?? 0) > unit.filling"
            >{{ unit.name }} ({{ unit.filling }} kg)
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

    <div class="col-span-2 py-2">
      <h3 class="text-neutral-700">Select Hydrogen Composition</h3>
      @if (storage.value && bottleFormGroup.value.amount) {
        <mat-radio-group
          required
          class="flex w-full flex-row gap-2"
          aria-label="Select an option"
          formControlName="type"
        >
          <div
            class="flex w-1/3 flex-col rounded-md border-[2px] border-solid p-2"
            [ngClass]="
              bottleFormGroup.value.type === 'GREEN'
                ? 'border-primary-400 text-primary-100'
                : 'border-neutral-400 text-neutral-500'
            "
          >
            <mat-radio-button
              #green
              value="GREEN"
              [disabled]="!isAmountAvailable(bottleFormGroup.value.amount, storage.value.hydrogenComposition)"
              >GREEN</mat-radio-button
            >
            <span class="ml-2 text-sm"
              >The bottling will contain green hydrogen only. Available Amount:
              {{ getAvailableGreenAmount(storage.value.hydrogenComposition) }} kg</span
            >
          </div>
          <div
            class="flex w-2/3 flex-col rounded-md border-[2px] border-solid p-2"
            [ngClass]="
              bottleFormGroup.value.type === 'MIX'
                ? 'border-primary-400 text-primary-100'
                : 'border-neutral-400 text-neutral-500'
            "
          >
            <mat-radio-button #mix value="MIX">MIX</mat-radio-button>
            <span class="ml-2 text-sm"
              >The composition of the filling will correspond to the hydrogen composition of the selected storage unit:
              {{ displayComposition(storage.value.hydrogenComposition) }}.</span
            >
          </div>
        </mat-radio-group>
      } @else {
        <span class="text-sm text-neutral-500">Please choose a storage unit and the desired amount first.</span>
      }
    </div>

    <app-upload-form
      class="col-span-2"
      [title]="'Add Files'"
      [uploadedFiles]="uploadedFiles"
      (uploadDocument)="submitFile($event)"
      (removeDocument)="removeFile($event)"
    ></app-upload-form>
  </div>

  @if (mutation.isError()) {
    <app-error-card [message]="mutation.error().message"></app-error-card>
  }

  <div class="flex justify-end gap-2">
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-flat-button (click)="createBottleData()" [disabled]="!bottleFormGroup.valid">Add Bottle</button>
  </div>
</div>
