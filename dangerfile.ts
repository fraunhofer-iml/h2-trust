import { danger, markdown, warn } from 'danger';

// ENFORCE LOCKFILE UP TO DATE
const packagesChanged = danger.git.modified_files.includes('package.json');
const lockfileChanged = ['package-lock.json'].some((file) => danger.git.modified_files.includes(file));

if (packagesChanged && !lockfileChanged) {
  const message = 'Changes were made to package.json, but not to package-lock.yml';
  const idea = 'Perhaps you need to run `npm install`?';
  warn(`${message} - <i>${idea}</i>`);
}

// ENCOURAGE SMALLER MRs
var bigMRThreshold = 50;
if (danger.gitlab.mr.changes_count.length > bigMRThreshold) {
  warn(':exclamation: Big MR (' + danger.gitlab.mr.changes_count.length + ')');
  markdown(
    '> (' +
      danger.gitlab.mr.changes_count.length +
      ') : Merge request size seems relatively large. If merge request contains multiple changes, split each into separate MR will helps faster, easier review.'
  );
}

if (!danger.gitlab.mr.assignee) {
  const method = danger.gitlab.mr.title.includes('Draft') ? warn : fail;
  method('This merge request needs an assignee, and optionally include any reviewers.');
}

if (danger.gitlab.mr.description.length < 10) {
  fail('This merge request needs a description.');
}

// Check for Merge Request Description if it only contains Resolves/Related to Issue fail
if (danger.gitlab.mr.description.match(/(Resolves) \D+-\d+/)) {
  fail('Merge Request Description should not only contain Resolves/Related to Issue');
}
